name: Site build preview

on:
    pull_request:
        types: [opened, synchronize]
        branches:
            - main

env:
    SYNC_REPO: ${{ secrets.SYNC_REPO }}
    SYNC_DIRS: "api-design docs guides mcp openapi"
    BRANCH_NAME: docs-preview/pr-${{ github.event.pull_request.number }}

jobs:
    preview-sync-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Install dependencies
              run: |
                  sudo apt-get update && sudo apt-get install -y jq
                  npm install -g vercel

            - name: Checkout developer-docs PR
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Clone marketing-site preview branch
              env:
                  TOKEN: ${{ secrets.SERVICE_BOT_TOKEN }}
              run: |
                  git clone https://x-access-token:${TOKEN}@github.com/${SYNC_REPO}.git private-repo
                  cd private-repo
                  git checkout -B $BRANCH_NAME

            - name: Sync content folders to preview branch
              run: |
                  set -euo pipefail
                  for dir in $SYNC_DIRS; do
                    src_dir="$dir"
                    dest_dir="private-repo/src/content/$dir"
                    if [ -d "$src_dir" ]; then
                      echo "Syncing $src_dir → $dest_dir"
                      rsync -a --delete "$src_dir/" "$dest_dir/"
                    else
                      echo "Warning: $src_dir does not exist, skipping..."
                    fi
                  done

            - name: Commit and push preview branch
              run: |
                  set -euo pipefail
                  cd private-repo
                  git config user.name "Beezy the bot"
                  git config user.email "marketing@speakeasy.com"
                  git add .
                  if git diff --cached --quiet; then
                    echo "No changes to sync for preview"
                    exit 0
                  fi
                  git commit -m "🔍 Preview sync from developer-docs PR #${{ github.event.pull_request.number }}"
                  git push origin $BRANCH_NAME --force

            - name: Deploy to Vercel via CLI
              id: deploy
              working-directory: private-repo
              env:
                  VERCEL_TOKEN: ${{ secrets.SERVICE_BOT_VERCEL }}
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.MARKETING_SITE_VERCEL_ID }}
              run: |
                  output=$(vercel --token $VERCEL_TOKEN --scope $VERCEL_ORG_ID --yes)
                  echo "$output"
                  deployment_url=$(echo "$output" | grep -o 'https://[^ ]*\.vercel\.app' | tail -n1)
                  echo "deployment-url=$deployment_url" >> $GITHUB_OUTPUT

            - name: Comment with Preview Link
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  number: ${{ github.event.pull_request.number }}
                  header: VercelPreview
                  message: |
                      🔗 **Preview your changes**:  
                      [View on Vercel](${{ steps.deploy.outputs.deployment-url }})  
                      _(This link may still be building...)_
